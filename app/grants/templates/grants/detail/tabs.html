{% comment %}
  Copyright (C) 2020 Gitcoin Core

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published
  by the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program. If not, see <http://www.gnu.org/licenses/>.
{% endcomment %}
{% load static humanize i18n grants_extra %}
<div class="px-lg-5">
  <div id="grant-profile-tabs" class="tab-container font-body mt-5 mb-4">

    <button type="button" id="nav-activity" href="{{grant.url}}?tab=activity" class="section-tab {% if tab == "activity" %} active {% endif %}">
      {% trans "ACTIVITY" %}
    </button>

    <button type="button" id="nav-description" href="{{grant.url}}?tab=description" class="section-tab {% if tab == "description" %} active {% endif %}">
      {% trans "DESCRIPTION" %}
    </button>

    <button type="button" id="nav-transactions" href="{{grant.url}}?tab=transactions" class="section-tab {% if tab == "transactions" %} active {% endif %}">
      {% trans "TRANSACTIONS" %}
      <span class="nav-badge">({{ activity_count }})</span>
    </button>

    <button type="button" id="nav-stats" href="{{grant.url}}?tab=stats" class="section-tab {% if tab == "stats" %} active {% endif %}">
      {% trans "STATS" %}
    </button>

    <button type="button" id="nav-summary" href="{{grant.url}}?tab=updates" class="section-tab {% if tab == "updates" %} active {% endif %}">
      {% trans "UPDATES" %}
      <span class="nav-badge">({{ updates|length }})</span>
    </button>

    <button type="button" id="nav-contributors" href="{{grant.url}}?tab=contributors" class="section-tab {% if tab == "contributors" %} active {% endif %}">
      {% trans "CONTRIBUTORS" %}
      <span class="nav-badge">({{ grant.contributor_count }})</span>
    </button>

  </div>

  <div id="grant-profile-tabs-sections" class="tab-sections section pt-2">

    {% if tab == "activity" %}
    <div id="section-nav-activity" class="tab-section active">
      {% if is_team_member %}
        {% include 'profiles/status_box.html' with suppress_tags=1 placeholder="Update Grant's Funders" what="grant" whatid=grant.pk max_length=1000  %}
      {% else %}
        {% include 'profiles/status_box.html' with suppress_tags=1 placeholder="Write on grants wall" what="grant" whatid=grant.pk %}
      {% endif %}
      <div id="activities" class="activity_stream container px-0">
        {% include 'shared/activity_container.html' %}
      </div>
     
    </div>
    {% endif %}

    {% if tab == "description" %}
    <div id="section-nav-description" class="tab-section active">
      <div id="editor">
        {% if grant.description_rich %}
          {{ grant.description_rich }}
        {% else %}
          {{ grant.description }}
        {% endif %}
      </div>
    </div>
    {% endif %}

    {% if tab == "transactions" %}
      <div id="section-nav-transactions">
        {% if not subscriptions and not cancelled_subscriptions and not contributions %}
          <h4 class="m-auto text-center font-weight-semibold">{% trans "No Activity for this Grant!" %}</h4>
        {% else %}
          {% include 'grants/activity.html' %}
          <span id="grant-network" class="hidden">{{ grant.network }}</span>
        {% endif %}
      </div>
    {% endif %}

    {% if tab == "updates" %}
      <div id="section-nav-summary">
        {% include 'grants/detail/summary.html' %}
      </div>
    {% endif %}

    {% if tab == "stats" %}
      <script src="https://www.gstatic.com/charts/loader.js"></script>
      <script src="{% static "v2/js/grants/stats.js" %}"></script>
      <div id=grant_stats_graph class="content-block content-block--white">
        <div class="container">

          <div class="value-container">
            <div class="chart_container chart_container--big">
              <p class="sub-title font-weight-semibold font-caption mb-1 pt-1">CONTRIBUTION HISTORY OVER TIME</p>
              <div class="chart_container__content">
                <div id="grant_chart"></div>
              </div>
              <div class="grant-status-list">
                <p><span class="box box_1"></span>{% trans "Subscription Billing" %}</p>
                <p><span class="box box_2"></span>{% trans "New Subscriptions" %}</p>
                <p><span class="box box_3"></span>{% trans "One-Time Contributions" %}</p>
                <p><span class="box box_5"></span>{% trans "CLR Matching Funds" %}</p>
              </div>
            </div>
          </div>
          <script>
            const max_graph = {{max_graph}};
            const history = {{history|safe}}; 
          </script>
        </div>
      </div>
    {% endif %}
    {% if tab == "contributors" %}
    <div id="section-nav-contributors">
      <div class="grant__stakeholders-list d-flex flex-wrap">
        {% for contribution in contributors %}
          {% if contribution.subscription %}
            {% trans  contribution.subscription.contributor_profile.handle  as handle %}
          {% else %}
            {% trans  contribution.profile.handle  as handle %}
          {% endif %}
          <a class="grant__stakeholders-item mr-3 mb-3" href="{% url 'profile' handle %}">
            <div class="mr-2 d-inline-block">
              <img src="/dynamic/avatar/{{handle}}" />
            </div>
            <div class="mt-1 d-inline-block">
              <span class="grant-profile font-weight-semibold">{{ handle }}</span><br>
              {% if handle == request.user.profile.handle  %}
              <a href="{%  url "grants:contribution_invoice" contribution.id  %}">Get invoice</a>
              {% endif %}
            </div>
          </a>

        {% empty %}
          <div class="no-subscriptions">
            <p class="mb-1">{% trans "No contributors." %}</p>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
  {% with description_tab_url=grant.url|addstr:'?tab=description' %}
      let grant_description;

      {% if tab == 'description' %}
        grant_description = new Quill('#editor', {
            theme: 'bubble',
            readOnly: true,
          });

        {% if is_team_member and not grant_is_inactive %}
          grant_description = new Quill('#editor', {
            theme: 'snow',
          });
          grant_description.enable(false);
        {% endif %}

        let desc = JSON.parse(grant_description.getContents().ops[0].insert);
        if (desc.ops) {
          grant_description.setContents(desc);
        }
      {% endif %}
  {% endwith %}
</script>
